"use strict";(self["webpackChunkshanotes_ui"]=self["webpackChunkshanotes_ui"]||[]).push([[591],{5591:function(t,e,a){a.r(e),a.d(e,{default:function(){return J}});var i=a(3396);const l={id:"main"};function n(t,e,a,n,o,d){const r=(0,i.up)("PathTree"),s=(0,i.up)("mavon-editor"),c=(0,i.Q2)("loading");return(0,i.wg)(),(0,i.iD)("div",l,[(0,i.Wm)(r,{onClick_path:d.handleClickPath},null,8,["onClick_path"]),o.cur_path&&1!=o.cur_path.link_type?(0,i.wy)(((0,i.wg)(),(0,i.j4)(s,{key:0,id:"md-editor",modelValue:o.markdown_content,"onUpdate:modelValue":e[0]||(e[0]=t=>o.markdown_content=t),onSave:d.saveFile,defaultOpen:"preview",subfield:!1,toolbars:o.markdown_options,navigation:!0},null,8,["modelValue","onSave","toolbars"])),[[c,o.loading]]):(0,i.kq)("",!0)])}var o=a(7139);const d=t=>((0,i.dD)("data-v-78a7395d"),t=t(),(0,i.Cn)(),t),r={class:"main"},s={class:"operator-bar"},c=(0,i.Uk)("文件夹"),_=(0,i.Uk)("文件"),h={class:"dialog-footer"},u=(0,i.Uk)("取消"),f=(0,i.Uk)("确认"),p={style:{"margin-bottom":"40px","font-size":"30px",color:"red"}},m=d((()=>(0,i._)("br",null,null,-1))),w={class:"dialog-footer"},k=(0,i.Uk)("取消"),y=(0,i.Uk)("确认");function g(t,e,a,l,n,d){const g=(0,i.up)("ArrowLeft"),v=(0,i.up)("el-icon"),W=(0,i.up)("el-button"),C=(0,i.up)("FolderOpened"),b=(0,i.up)("FolderAdd"),V=(0,i.up)("Delete"),D=(0,i.up)("el-button-group"),x=(0,i.up)("el-tree"),U=(0,i.up)("el-card"),N=(0,i.up)("el-radio"),F=(0,i.up)("el-radio-group"),S=(0,i.up)("el-form-item"),I=(0,i.up)("el-input"),M=(0,i.up)("el-form"),L=(0,i.up)("el-dialog"),O=(0,i.Q2)("loading");return(0,i.wg)(),(0,i.iD)("div",r,[(0,i.Wm)(U,{id:"card"},{header:(0,i.w5)((()=>[(0,i._)("div",s,[(0,i.Wm)(W,{text:"",onClick:d.handleFolderBack},{default:(0,i.w5)((()=>[(0,i.Wm)(v,null,{default:(0,i.w5)((()=>[(0,i.Wm)(g)])),_:1})])),_:1},8,["onClick"]),(0,i.Wm)(D,null,{default:(0,i.w5)((()=>[(0,i.Wm)(W,{text:"",onClick:d.open_folder},{default:(0,i.w5)((()=>[(0,i.Wm)(v,null,{default:(0,i.w5)((()=>[(0,i.Wm)(C)])),_:1})])),_:1},8,["onClick"]),(0,i.Wm)(W,{text:"",onClick:e[0]||(e[0]=t=>n.dialog_vis=!0)},{default:(0,i.w5)((()=>[(0,i.Wm)(v,null,{default:(0,i.w5)((()=>[(0,i.Wm)(b)])),_:1})])),_:1}),(0,i.Wm)(W,{type:"danger",onClick:d.del_link},{default:(0,i.w5)((()=>[(0,i.Wm)(v,null,{default:(0,i.w5)((()=>[(0,i.Wm)(V)])),_:1})])),_:1},8,["onClick"])])),_:1})])])),default:(0,i.w5)((()=>[(0,i.wy)((0,i.Wm)(x,{onNodeDrop:d.handleDrag,draggable:"","highlight-current":"",data:n.folder,"allow-drop":d.allowDrop,onNodeClick:d.handleNodeClick,props:{class:d.customNodeClass}},null,8,["onNodeDrop","data","allow-drop","onNodeClick","props"]),[[O,n.loading]])])),_:1}),(0,i.Wm)(L,{modelValue:n.dialog_vis,"onUpdate:modelValue":e[4]||(e[4]=t=>n.dialog_vis=t),title:"创建新路径","before-close":d.handleDiaClose},{footer:(0,i.w5)((()=>[(0,i._)("span",h,[(0,i.Wm)(W,{onClick:e[3]||(e[3]=t=>n.dialog_vis=!1)},{default:(0,i.w5)((()=>[u])),_:1}),(0,i.Wm)(W,{type:"primary",onClick:d.createLink},{default:(0,i.w5)((()=>[f])),_:1},8,["onClick"])])])),default:(0,i.w5)((()=>[(0,i.Wm)(M,{"label-width":"120px"},{default:(0,i.w5)((()=>[(0,i.Wm)(S,{label:"目录类型"},{default:(0,i.w5)((()=>[(0,i.Wm)(F,{modelValue:n.create_info.type,"onUpdate:modelValue":e[1]||(e[1]=t=>n.create_info.type=t)},{default:(0,i.w5)((()=>[(0,i.Wm)(N,{label:"folder"},{default:(0,i.w5)((()=>[c])),_:1}),(0,i.Wm)(N,{label:"file"},{default:(0,i.w5)((()=>[_])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,i.Wm)(S,{label:"标题"},{default:(0,i.w5)((()=>[(0,i.Wm)(I,{modelValue:n.create_info.title,"onUpdate:modelValue":e[2]||(e[2]=t=>n.create_info.title=t),style:{width:"200px"},id:"path-name-input"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue","before-close"]),(0,i.Wm)(L,{modelValue:n.del_dia_vis,"onUpdate:modelValue":e[6]||(e[6]=t=>n.del_dia_vis=t),title:"删除确认"},{default:(0,i.w5)((()=>[(0,i._)("span",null,[(0,i._)("p",p,[(0,i.Uk)(" 你确定要删除"+(0,o.zw)(n.selected_folder.label)+"吗？删除操作不可撤销",1),m])]),(0,i._)("span",w,[(0,i.Wm)(W,{onClick:e[5]||(e[5]=t=>n.dialog_vis=!1)},{default:(0,i.w5)((()=>[k])),_:1}),(0,i.Wm)(W,{type:"primary",onClick:d.confirmDeleteLink},{default:(0,i.w5)((()=>[y])),_:1},8,["onClick"])])])),_:1},8,["modelValue"])])}var v=a(5937);async function W(){return await(0,v.gc)("/notes/root")}async function C(t,e){return await(0,v.Mx)("/notes/create_folder",{parent:t,title:e})}async function b(t,e){return await(0,v.Mx)("/notes/create_note",{parent:t,title:e})}async function V(t){return await(0,v.Mx)("/notes/del_link",{path_id:t})}async function D(t){return await(0,v.gc)("/notes/read_link",{path_id:t})}async function x(t,e){return await(0,v.Mx)("/notes/update_link",{path_id:t,content:e})}async function U(t){return await(0,v.gc)("/notes/read_meta",{path_id:t})}async function N(t,e){return await(0,v.Mx)("/notes/move_link",{path_id:t,parent:e})}async function F(t){let e=[],a=await(0,v.gc)("/notes/read_link",{path_id:t});if(200!=a.meta.status)return[];let i=a.content,l=JSON.parse(i.content),n=await(0,v.gc)("/notes/read_child",{path_id:t});if(200!=n.meta.status||!n.value)return[];let o=new Map;n=n.value;for(let d of n)o.set(d.id,d);for(let d of l)o.has(d)&&e.push(o.get(d));return e}function S(t){let e=[];for(let a of t)e.push(a.path_id);return e}var I=a(2807);const M=1;var L={async mounted(){let t=parseInt(window.localStorage.getItem("cur_fid"));this.froot=this.folder[0],t?(await this.reload_root(t),this.selected_fid=t):(this.selected_fid=0,this.selected_folder=this.froot,await this.reload_root())},data(){return{create_info:{title:"",type:""},selected_fid:0,selected_folder:null,loading:!1,dialog_vis:!1,del_dia_vis:!1,is_empty_folder:!1,froot:null,folder:[{label:"根目录",path_id:0,link_type:1,depth:0,children:[],parent:0}]}},methods:{customNodeClass(t,e){let a=e.data;return 1==a.link_type?"is-folder":null},async reload_root(t=0){let e;if(0==t)this.froot.parent=0,this.froot.path_id=0,this.froot.label="根目录",this.froot.depth=0,this.froot.children=[],this.loading=!0,e=await W(),this.loading=!1,this.is_empty_folder=200!=e.meta.status,this.is_empty_folder||(this.froot.children=await this.process_folder(e.value,0,1,1));else{let a=await D(t);if(200!=a.meta.status)return alert(a.meta.message);a=a.content,this.froot.path_id=a.id,this.froot.label=a.title,this.froot.parent=a.parent,this.froot.depth=0,this.froot.children=[],this.loading=!0,e=await F(t),this.loading=!1,this.is_empty_folder=null==e,this.is_empty_folder||(this.froot.children=await this.process_folder(e,this.froot.path_id,1))}},async process_folder(t,e,a=1,i){let l=[];for(let n of t){let t={label:n.title,depth:a,path_id:n.id,link_type:n.link_type,children:null,parent:e};if(a<=i&&n.link_type==M){let e=await F(n.id);null!=e&&(t.children=await this.process_folder(e,n.id,a+1,i))}void 0!=n.children&&null!=n.children&&(t.children=n.children),l.push(t)}return l},async sync_folder_info(t){let e=S(t.children);return await x(t.path_id,JSON.stringify(e))},handleDiaClose(){this.dialog_vis=!1},async handleFolderBack(){0!=this.froot.path_id&&(await this.reload_root(this.froot.parent),window.localStorage.setItem("cur_fid",this.froot.parent))},async createLink(){if(this.create_info.title.length<1)return alert("标题必须长度必须大于1");if("folder"==this.create_info.type){let t=await C(this.selected_fid,this.create_info.title);if(200!=t.meta.status)return alert("创建失败");t=t.id;let e={label:this.create_info.title,path_id:t,link_type:1,children:[]};this.selected_folder.children.push(e)}else if("file"==this.create_info.type){let t=await b(this.selected_fid,this.create_info.title);if(200!=t.meta.status)return alert("创建失败");t=t.id;let e={label:this.create_info.title,path_id:t,link_type:2,children:[]};this.selected_folder.children.push(e)}this.dialog_vis=!1},del_link(){this.del_dia_vis=!0},async open_folder(){this.selected_folder.link_type!=M?(0,I.z8)({message:"请打开一个文件夹",type:"error"}):(window.localStorage.setItem("cur_fid",this.selected_fid),await this.reload_root(this.selected_fid))},async confirmDeleteLink(){await V(this.selected_fid),this.del_dia_vis=!1;let t=e=>{if(e.link_type==M&&e.children){e.children=e.children.filter((t=>t.path_id!=this.selected_fid));for(let a of e.children)t(a)}};t(this.froot)},allowDrop(t,e,a){return"inner"==a?1==e.data.link_type:0!=e.data.depth},async handleNodeClick(t){if(this.selected_fid=t.path_id,this.selected_folder=t,this.$emit("click_path",this.selected_folder),"2"==t.link_type);else if(!t.children){let e=await F(t.path_id);t.children=await this.process_folder(e,t.depth+1,t.depth+2)}},async handleDrag(t,e,a){let i=e;t=t.data,e=e.data;let l=t.path_id,n=e.path_id,o=await U(t.path_id),d=await U(e.path_id);if("inner"==a){let t=await N(l,n);if(200!=t.meta.status)return alert(t.meta.message);if(!this.sync_folder_info(e))return alert("更新文件夹信息失败")}else if(o.parent==d.parent)await this.sync_folder_info(i.parent.data);else{let t=await N(l,e.parent);if(200!=t.meta.status)return alert(t.meta.message);await this.sync_folder_info(i.parent.data)}}}},O=a(89);const P=(0,O.Z)(L,[["render",g],["__scopeId","data-v-78a7395d"]]);var z=P,A={components:{PathTree:z},data(){return{markdown_options:{navigation:!0,undo:!0,redo:!0,trash:!0,save:!0,subfield:!0,preview:!0},markdown_content:"",cur_path:"",raw_content:"",loading:!1}},computed:{updated(){return this.raw_content!=this.markdown_content}},methods:{async saveFile(){this.loading=!0;let t=this.cur_path.path_id,e=await x(t,this.markdown_content);return this.loading=!1,200!=e.meta.status?alert("保存失败"):(this.raw_content=this.markdown_content,alert("保存成功"))},async handleClickPath(t){if(!t||0==t.path_id||1==t.link_type)return;this.updated&&await this.saveFile(),this.cur_path=t,console.log(t),this.loading=!0;let e=await D(t.path_id);if(this.loading=!1,200!=e.meta.status)return alert("请求数据失败");e=e.content,this.markdown_content=null==e.content?"":e.content,this.raw_content=this.markdown_content}}};const B=(0,O.Z)(A,[["render",n],["__scopeId","data-v-018896e4"]]);var J=B}}]);
//# sourceMappingURL=591.6649c205.js.map