"use strict";(self["webpackChunkshanotes_ui"]=self["webpackChunkshanotes_ui"]||[]).push([[417],{417:function(e,t,a){a.r(t),a.d(t,{default:function(){return Y}});var l=a(3396);const i={id:"main"},n={class:"md",style:{oveflow:"auto"}};function o(e,t,a,o,d,r){const s=(0,l.up)("PathTree"),_=(0,l.up)("mavon-editor"),u=(0,l.Q2)("loading");return(0,l.wg)(),(0,l.iD)("div",i,[(0,l.Wm)(s,{id:"tree-nav",onClick_path:r.handleClickPath},null,8,["onClick_path"]),(0,l._)("div",n,[d.cur_path&&1!=d.cur_path.link_type?(0,l.wy)(((0,l.wg)(),(0,l.j4)(_,{key:0,id:"md-editor",modelValue:d.markdown_content,"onUpdate:modelValue":t[0]||(t[0]=e=>d.markdown_content=e),onSave:r.saveFile,defaultOpen:"preview",subfield:!1,toolbars:d.markdown_options},null,8,["modelValue","onSave","toolbars"])),[[u,d.loading]]):(0,l.kq)("",!0)])])}var d=a(7139);const r=e=>((0,l.dD)("data-v-bbc59b7a"),e=e(),(0,l.Cn)(),e),s={class:"main"},_={class:"operator-bar"},u={style:{"text-align":"left"}},c={class:"tree-div"},f=(0,l.Uk)("文件夹"),h=(0,l.Uk)("文件"),p={class:"dialog-footer"},m=(0,l.Uk)("取消"),w=(0,l.Uk)("确认"),k={style:{"margin-bottom":"40px","font-size":"30px",color:"red"}},y=r((()=>(0,l._)("br",null,null,-1))),g={class:"dialog-footer"},v=(0,l.Uk)("取消"),W=(0,l.Uk)("确认"),b={style:{"margin-bottom":"20px"}},C=(0,l.Uk)("取消"),V=(0,l.Uk)("确认"),x={style:{"font-size":"20px"}},U=r((()=>(0,l._)("br",null,null,-1))),D=r((()=>(0,l._)("br",null,null,-1))),N={key:0,style:{color:"red","font-size":"20px"}};function z(e,t,a,i,n,o){const r=(0,l.up)("ArrowLeft"),z=(0,l.up)("el-icon"),F=(0,l.up)("el-button"),S=(0,l.up)("FolderOpened"),I=(0,l.up)("FolderAdd"),M=(0,l.up)("Delete"),O=(0,l.up)("el-button-group"),A=(0,l.up)("EditPen"),L=(0,l.up)("DocumentCopy"),P=(0,l.up)("el-tree"),R=(0,l.up)("el-card"),Q=(0,l.up)("el-radio"),J=(0,l.up)("el-radio-group"),q=(0,l.up)("el-form-item"),B=(0,l.up)("el-input"),E=(0,l.up)("el-form"),T=(0,l.up)("el-dialog"),Z=(0,l.Q2)("loading");return(0,l.wg)(),(0,l.iD)("div",s,[(0,l.Wm)(R,{id:"card"},{header:(0,l.w5)((()=>[(0,l._)("div",null,[(0,l._)("div",_,[(0,l.Wm)(F,{text:"",onClick:e.handleFolderBack},{default:(0,l.w5)((()=>[(0,l.Wm)(z,null,{default:(0,l.w5)((()=>[(0,l.Wm)(r)])),_:1})])),_:1},8,["onClick"]),(0,l.Wm)(O,null,{default:(0,l.w5)((()=>[(0,l.Wm)(F,{text:"",onClick:e.open_folder},{default:(0,l.w5)((()=>[(0,l.Wm)(z,null,{default:(0,l.w5)((()=>[(0,l.Wm)(S)])),_:1})])),_:1},8,["onClick"]),(0,l.Wm)(F,{text:"",onClick:t[0]||(t[0]=t=>e.dialog_vis=!0)},{default:(0,l.w5)((()=>[(0,l.Wm)(z,null,{default:(0,l.w5)((()=>[(0,l.Wm)(I)])),_:1})])),_:1}),(0,l.Wm)(F,{type:"danger",onClick:e.del_link},{default:(0,l.w5)((()=>[(0,l.Wm)(z,null,{default:(0,l.w5)((()=>[(0,l.Wm)(M)])),_:1})])),_:1},8,["onClick"])])),_:1})]),(0,l._)("div",u,[(0,l.Wm)(O,null,{default:(0,l.w5)((()=>[(0,l.Wm)(F,{text:"",onClick:e.handleRename},{default:(0,l.w5)((()=>[(0,l.Wm)(z,null,{default:(0,l.w5)((()=>[(0,l.Wm)(A)])),_:1})])),_:1},8,["onClick"]),(0,l.Wm)(F,{type:"success",onClick:e.handleOutFolder},{default:(0,l.w5)((()=>[(0,l.Wm)(z,null,{default:(0,l.w5)((()=>[(0,l.Wm)(L)])),_:1})])),_:1},8,["onClick"])])),_:1})])])])),default:(0,l.w5)((()=>[(0,l._)("div",c,[(0,l.wy)((0,l.Wm)(P,{onNodeDrop:e.handleDrag,draggable:"","highlight-current":"",data:e.folder,"allow-drop":e.allowDrop,onNodeClick:e.handleNodeClick,props:{class:e.customNodeClass}},null,8,["onNodeDrop","data","allow-drop","onNodeClick","props"]),[[Z,e.loading]])])])),_:1}),(0,l.Wm)(T,{modelValue:e.dialog_vis,"onUpdate:modelValue":t[4]||(t[4]=t=>e.dialog_vis=t),title:"创建新路径","before-close":e.handleDiaClose},{footer:(0,l.w5)((()=>[(0,l._)("span",p,[(0,l.Wm)(F,{onClick:t[3]||(t[3]=t=>e.dialog_vis=!1)},{default:(0,l.w5)((()=>[m])),_:1}),(0,l.Wm)(F,{type:"primary",onClick:e.createLink},{default:(0,l.w5)((()=>[w])),_:1},8,["onClick"])])])),default:(0,l.w5)((()=>[(0,l.Wm)(E,{"label-width":"120px"},{default:(0,l.w5)((()=>[(0,l.Wm)(q,{label:"目录类型"},{default:(0,l.w5)((()=>[(0,l.Wm)(J,{modelValue:e.create_info.type,"onUpdate:modelValue":t[1]||(t[1]=t=>e.create_info.type=t)},{default:(0,l.w5)((()=>[(0,l.Wm)(Q,{label:"folder"},{default:(0,l.w5)((()=>[f])),_:1}),(0,l.Wm)(Q,{label:"file"},{default:(0,l.w5)((()=>[h])),_:1})])),_:1},8,["modelValue"])])),_:1}),(0,l.Wm)(q,{label:"标题"},{default:(0,l.w5)((()=>[(0,l.Wm)(B,{modelValue:e.create_info.title,"onUpdate:modelValue":t[2]||(t[2]=t=>e.create_info.title=t),style:{width:"200px"},id:"path-name-input"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue","before-close"]),(0,l.Wm)(T,{modelValue:e.del_dia_vis,"onUpdate:modelValue":t[6]||(t[6]=t=>e.del_dia_vis=t),title:"删除确认"},{default:(0,l.w5)((()=>[(0,l._)("span",null,[(0,l._)("p",k,[(0,l.Uk)(" 你确定要删除"+(0,d.zw)(e.selected_folder.label)+"吗？删除操作不可撤销",1),y])]),(0,l._)("span",g,[(0,l.Wm)(F,{onClick:t[5]||(t[5]=t=>e.dialog_vis=!1)},{default:(0,l.w5)((()=>[v])),_:1}),(0,l.Wm)(F,{type:"primary",onClick:e.confirmDeleteLink},{default:(0,l.w5)((()=>[W])),_:1},8,["onClick"])])])),_:1},8,["modelValue"]),(0,l.Wm)(T,{modelValue:e.rename_dia_vis,"onUpdate:modelValue":t[9]||(t[9]=t=>e.rename_dia_vis=t),title:"重命名"},{default:(0,l.w5)((()=>[(0,l.Wm)(E,{"label-width":"120px"},{default:(0,l.w5)((()=>[(0,l.Wm)(q,{label:"新的路径名称: "},{default:(0,l.w5)((()=>[(0,l.Wm)(B,{modelValue:e.rename_input,"onUpdate:modelValue":t[7]||(t[7]=t=>e.rename_input=t),style:{width:"400px"}},null,8,["modelValue"])])),_:1})])),_:1}),(0,l._)("span",b,[(0,l.Wm)(F,{onClick:t[8]||(t[8]=t=>e.rename_dia_vis=!1)},{default:(0,l.w5)((()=>[C])),_:1}),(0,l.Wm)(F,{type:"primary",onClick:e.confirmRename},{default:(0,l.w5)((()=>[V])),_:1},8,["onClick"])])])),_:1},8,["modelValue"]),(0,l.Wm)(T,{modelValue:e.output_dia_vis,"onUpdate:modelValue":t[10]||(t[10]=t=>e.output_dia_vis=t),title:"导出中"},{default:(0,l.w5)((()=>[(0,l._)("span",x,[(0,l._)("p",null,"正在导出的文件夹: "+(0,d.zw)(e.output_md_info.folder),1),U,(0,l._)("p",null,"正在导出的文件: "+(0,d.zw)(e.output_md_info.file),1),D]),e.output_md_info.finished?((0,l.wg)(),(0,l.iD)("p",N," 导出完成")):(0,l.kq)("",!0)])),_:1},8,["modelValue"])])}var F=a(5937);async function S(){return await(0,F.gc)("/notes/root")}async function I(e,t){return await(0,F.Mx)("/notes/create_folder",{parent:e,title:t})}async function M(e,t){return await(0,F.Mx)("/notes/create_note",{parent:e,title:t})}async function O(e){return await(0,F.Mx)("/notes/del_link",{path_id:e})}async function A(e){return await(0,F.gc)("/notes/read_link",{path_id:e})}async function L(e,t){return await(0,F.Mx)("/notes/update_link",{path_id:e,content:t})}async function P(e){return await(0,F.gc)("/notes/read_meta",{path_id:e})}async function R(e,t){return await(0,F.Mx)("/notes/move_link",{path_id:e,parent:t})}async function Q(e,t){return await(0,F.Mx)("/notes/rename",{path_id:e,name:t})}async function J(e){let t=[],a=await(0,F.gc)("/notes/read_link",{path_id:e});if(200!=a.meta.status)return[];let l=a.content,i=JSON.parse(l.content),n=await(0,F.gc)("/notes/read_child",{path_id:e});if(200!=n.meta.status||!n.value)return[];let o=new Map;n=n.value;for(let d of n)o.set(d.id,d);for(let d of i)o.has(d)&&t.push(o.get(d));return t}function q(e){let t=[];for(let a of e)t.push(a.path_id);return t}async function B(e,t,a){let l="",i=await A(e);if(200!=i.meta.status)return"\n# 导出id 为"+e+"失败了QAQ\n";if(i=i.content,1==i.link_type){a.folder=i.title;let e=t,n="";while(e--)n+="#";t&&(l+="\n"+n+" "+i.title+"\n\n");let o=JSON.parse(i.content);for(let i of o)l+=await B(i,t+1,a);a.folder=`loading folder: ${i.title}`}else a.file=i.title,l+=(i.content,i.content);return l}async function E(e,t={folder:"",file:""}){t.finished=!1;let a=await B(e,0,t);t.finished=!0;const l=document.createElement("a");l.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a)),l.setAttribute("download","文档.md"),l.style.display="none",l.click()}var T=a(2807);const Z=1;var $={async mounted(){let e=parseInt(window.localStorage.getItem("cur_fid"));this.froot=this.folder[0],e?(await this.reload_root(e),this.selected_fid=e):(this.selected_fid=0,this.selected_folder=this.froot,await this.reload_root())},data(){return{create_info:{title:"",type:""},output_md_info:{folder:"",file:"",finished:!1},selected_fid:0,selected_folder:null,loading:!1,dialog_vis:!1,del_dia_vis:!1,rename_dia_vis:!1,rename_input:"",output_dia_vis:!1,is_empty_folder:!1,froot:null,folder:[{label:"根目录",path_id:0,link_type:1,depth:0,children:[],parent:0}]}},methods:{customNodeClass(e,t){let a=t.data;return 1==a.link_type?"is-folder":null},async reload_root(e=0){let t;if(0==e)this.froot.parent=0,this.froot.path_id=0,this.froot.label="根目录",this.froot.depth=0,this.froot.children=[],this.loading=!0,t=await S(),this.loading=!1,this.is_empty_folder=200!=t.meta.status,this.is_empty_folder||(this.froot.children=await this.process_folder(t.value,0,1,1));else{let a=await A(e);if(200!=a.meta.status)return alert(a.meta.message);a=a.content,this.froot.path_id=a.id,this.froot.label=a.title,this.froot.parent=a.parent,this.froot.depth=0,this.froot.children=[],this.loading=!0,t=await J(e),this.loading=!1,this.is_empty_folder=null==t,this.is_empty_folder||(this.froot.children=await this.process_folder(t,this.froot.path_id,1))}},async process_folder(e,t,a=1,l){let i=[];for(let n of e){let e={label:n.title,depth:a,path_id:n.id,link_type:n.link_type,children:null,parent:t};if(a<=l&&n.link_type==Z){let t=await J(n.id);null!=t&&(e.children=await this.process_folder(t,n.id,a+1,l))}void 0!=n.children&&null!=n.children&&(e.children=n.children),i.push(e)}return i},async sync_folder_info(e){let t=q(e.children);return await L(e.path_id,JSON.stringify(t))},handleDiaClose(){this.dialog_vis=!1},async handleFolderBack(){0!=this.froot.path_id&&(await this.reload_root(this.froot.parent),window.localStorage.setItem("cur_fid",this.froot.parent))},async createLink(){if(this.create_info.title.length<1)return alert("标题必须长度必须大于1");if("folder"==this.create_info.type){let e=await I(this.selected_fid,this.create_info.title);if(200!=e.meta.status)return alert("创建失败");e=e.id;let t={parent:this.selected_fid,label:this.create_info.title,path_id:e,link_type:1,children:[]};this.selected_folder.children.push(t)}else if("file"==this.create_info.type){let e=await M(this.selected_fid,this.create_info.title);if(200!=e.meta.status)return alert("创建失败");e=e.id;let t={parent:this.selected_fid,label:this.create_info.title,path_id:e,link_type:2,children:[]};this.selected_folder.children.push(t)}this.dialog_vis=!1},del_link(){this.del_dia_vis=!0},async open_folder(){this.selected_folder.link_type!=Z?(0,T.z8)({message:"请打开一个文件夹",type:"error"}):(window.localStorage.setItem("cur_fid",this.selected_fid),await this.reload_root(this.selected_fid))},async confirmDeleteLink(){await O(this.selected_fid),this.del_dia_vis=!1;let e=t=>{if(t.link_type==Z&&t.children){t.children=t.children.filter((e=>e.path_id!=this.selected_fid));for(let a of t.children)e(a)}};e(this.froot)},allowDrop(e,t,a){return"inner"==a?1==t.data.link_type:0!=t.data.depth},async handleNodeClick(e){if(this.selected_fid=e.path_id,this.selected_folder=e,this.$emit("click_path",this.selected_folder),"2"==e.link_type);else if(!e.children){let t=await J(e.path_id);e.children=await this.process_folder(t,e.depth+1,e.depth+2)}},async handleDrag(e,t,a){let l=t;e=e.data,t=t.data;let i=e.path_id,n=t.path_id,o=await P(e.path_id),d=await P(t.path_id);if("inner"==a){let e=await R(i,n);if(200!=e.meta.status)return alert(e.meta.message);if(!this.sync_folder_info(t))return alert("更新文件夹信息失败")}else if(o.parent==d.parent)await this.sync_folder_info(l.parent.data);else{let e=await R(i,t.parent);if(200!=e.meta.status)return alert(e.meta.message);await this.sync_folder_info(l.parent.data)}},async handleRename(){if(0==this.selected_fid)return(0,T.z8)({type:"error",message:"根目录不能重命名"});this.rename_dia_vis=!0},async confirmRename(){this.rename_dia_vis=!1;let e=await Q(this.selected_fid,this.rename_input);return 200!=e.meta.status?(0,T.z8)({type:"error",message:e.meta.message}):(this.selected_folder.label=this.rename_input,(0,T.z8)({type:"success",message:"重命名成功"}))},async handleOutFolder(){this.output_dia_vis=!0,await E(this.selected_fid,this.output_md_info)}}},j=a(89);const G=(0,j.Z)($,[["render",z],["__scopeId","data-v-bbc59b7a"]]);var H=G,K={components:{PathTree:H},data(){return{markdown_options:{navigation:!0,undo:!0,redo:!0,trash:!0,save:!0,subfield:!0,preview:!0},markdown_content:"",cur_path:"",raw_content:"",loading:!1}},computed:{updated(){return this.raw_content!=this.markdown_content}},methods:{async saveFile(){this.loading=!0;let e=this.cur_path.path_id,t=await L(e,this.markdown_content);return this.loading=!1,200!=t.meta.status?alert("保存失败"):(this.raw_content=this.markdown_content,alert("保存成功"))},async handleClickPath(e){if(!e||0==e.path_id||1==e.link_type)return;this.updated&&await this.saveFile(),this.cur_path=e,console.log(e),this.loading=!0;let t=await A(e.path_id);if(this.loading=!1,200!=t.meta.status)return alert("请求数据失败");t=t.content,this.markdown_content=null==t.content?"":t.content,this.raw_content=this.markdown_content}}};const X=(0,j.Z)(K,[["render",o],["__scopeId","data-v-0188a74b"]]);var Y=X}}]);
//# sourceMappingURL=417.18c4a6c6.js.map